<?xml version="1.0" encoding="UTF-8" ?>

<project name="jdee" default="configure-ebuild">

  <property name="project.dir" location="."/>

  <property name="config.dir" location="${project.dir}/config"/>
  <property name="config.build.file" location="${config.dir}/config.properties"/>

  <property name="src.lisp.dir" location="${project.dir}/lisp"/>

  <property name="build.dir" location="${project.dir}/build"/>
  <property name="build.lisp.dir" location="${build.dir}/lisp"/>
  <property name="build.lisp.file" location="${build.lisp.dir}/build.el"/>

  <property name="dist.dir" location="${project.dir}/dist"/>


  <target name="init">
    <tstamp/>
    <uptodate property="config.uptodate" srcfile="${config.build.file}"
	      targetfile="${config.build.file}"/>
    <mkdir dir="${build.dir}"/>
  </target>

  <target name="init-compile" depends="init">
    <property file="${config.build.file}"/>
  </target>

  <target name="configure" depends="init" unless="config.uptodate">

    <!-- developers will usually have the following config file (i.e. source
         installed libs) -->
    <property file="${user.home}/.jdee-config.properties"/>

    <!-- project specific defaults (not user or instance specific) -->
    <property file="${config.dir}/default.properties"/>

    <propertyfile file="${config.build.file}" comment="user editable build configuration parameters">
      <entry key="config.time" type="date" value="now"/>
      <entry key="cedet.dir" value="${cedet.dir}"/>
      <entry key="elib.dir" value="${elib.dir}"/>
      <entry key="prefix.dir" value="${prefix.dir}"/>
    </propertyfile>
  </target>

  <target name="configure-ebuild" depends="configure">
    <mkdir dir="${build.lisp.dir}"/>

    <uptodate property="lisp-is-uptodate">
      <srcfiles dir="${build.lisp.dir}" includes="*.el"/>
      <mapper type="glob" from="*.el" to="*.elc"/>
    </uptodate>

    <copy todir="${build.lisp.dir}">
      <fileset dir="${src.lisp.dir}" includes="*.el"/>
    </copy>

<echo file="${build.lisp.file}">
(dolist (path '("common"
		"eieio"
		"semantic"
		"semantic/bovine"
		"speedbar"
		))
  (add-to-list 'load-path (expand-file-name path "${cedet.dir}") t))
(message "LOAD PATH: %s" (mapconcat #'identity load-path ":"))
(add-to-list 'load-path "${src.lisp.dir}")
(byte-recompile-directory (expand-file-name "${build.lisp.dir}") 0)
</echo>
  </target>

  <target name="build-lisp" depends="configure-ebuild" if="lisp-is-uptodate">
    <exec dir="${build.lisp.dir}" executable="emacs">
      <arg value="--script"/>
      <arg value="build.el"/>
    </exec>
  </target>


  <target name="clean" depends="init">
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
    <delete file="${config.build.file}"/>
  </target>

  <target name="cleanall" depends="clean">
  </target>

</project>
